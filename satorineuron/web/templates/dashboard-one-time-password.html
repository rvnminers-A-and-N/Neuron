{% block content %}
<div class="col-xl-6 col-lg-6 col-sm-12 mt-4 mb-3">
  <div
    class="card {% if darkmode %}dark-colors{% endif %}"
    style="height: 270px;">
    <div class="card-header pb-0 {% if darkmode %}dark-colors{% endif %}">
      <div class="row">
        <div class="col-lg-12 col-12">
          <h6 class="text-center {% if darkmode %}dark-colors{% endif %}" style="cursor: help" title="Enter Code">
            One-Time Password
          </h6>
          <p class="text-sm mb-0 text-center {% if darkmode %}dark-colors{% endif %}">
            <i>for use with the Satori website</i>
          </p>
          <p id="otp-outputStatus" class="text-sm mb-0 text-center {% if darkmode %}dark-colors{% endif %}">
          </p>
        </div>
      </div>
    </div>
    <div class="card-body pb-2">
      <!--<p class="text-sm mb-0 text-center {% if darkmode %}dark-colors{% endif %}">
        Wallet Address: 
        <span id="walletAddress">{{ wallet.address }}</span>
        <button 
          type="button" 
          class="btn ms-2" 
          onclick="copyToClipboard('walletAddress', this)"
          title="Copy wallet address"
          style="padding: 2px 6px; font-size: 12px;"
        ><i class="material-icons cursor-pointer">copy</i></button>
      </p>-->
      <div class="input-container">
        <div class="form-group">
          <!--<label for="userInput" class="form-label {% if darkmode %}dark-colors{% endif %}">Enter Code:</label>-->
          <div class="d-flex align-items-center">
            <div class="input-group input-group-outline" style="margin-right: 10px;">
              <input 
                type="text" 
                id="userInput" 
                class="form-control {% if darkmode %}dark-colors{% endif %}" 
                placeholder="Enter Code"
              />
            </div>
            <button 
              type="button" 
              id="submitButton" 
              class="btn btn-outline-secondary"
              onclick="processInput()"
              style="white-space: nowrap; position: unset; overflow: unset;margin-bottom: 0px;"
            >Submit</button>
          </div>
        </div>
      </div>
    </div>
    <div id="outputContainer" class="card-body" style="display: none;">
      <p class="text-sm mb-0 text-center {% if darkmode %}dark-colors{% endif %}">
        One-Time Password: <br>
        <span id="otp">Enter code above to generate OTP</span>
        <button 
          type="button" 
          class="btn ms-2" 
          onclick="copyToClipboard('otp', this)"
          title="Copy One-Time Password"
          style="padding: 2px 6px; font-size: 12px;"
        ><i class="material-icons cursor-pointer" >copy</i></button>
      </p>
    </div>
  </div>
</div>

<script>
  function truncateText(text, maxLength = 12) {
    if (text.length <= maxLength) {
      return text;
    }
    
    const start = text.substring(0, 4);
    const end = text.substring(text.length - 4);
    
    // Handle middle section based on length
    let middle;
    if (text.length % 2 === 0) {
      // Even length: get middle 4 characters
      const middleStart = Math.floor((text.length - 4) / 2);
      middle = text.substring(middleStart, middleStart + 4);
    } else {
      // Odd length: get middle character and 1 on each side
      const middleIndex = Math.floor(text.length / 2);
      middle = text.substring(middleIndex - 1, middleIndex + 2);
    }
    
    return `${start}...${middle}...${end}`;
  }

  function processInput() {
    var userInput = document.getElementById('userInput').value;
    var outputContainer = document.getElementById('outputContainer');
    var otpSpan = document.getElementById('otp');
    var submitButton = document.getElementById('submitButton');
    
    if (userInput.trim() === '') {
      alert('Please enter some text first!');
      return;
    }
    
    // Show loading state
    submitButton.disabled = true;
    submitButton.textContent = 'Generating...';
    otpSpan.textContent = 'Generating OTP...';
    outputContainer.style.display = 'block';
    
    // Call backend to generate OTP
    fetch('/generate/otp', { 
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ input: userInput })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      return response.json();
    })
    .then(data => {
      const fullOtp = data.otp || data.message || 'OTP generated';
      // Store the full text as a data attribute
      otpSpan.setAttribute('data-full-text', fullOtp);
      otpSpan.setAttribute('title', fullOtp);
      // Display truncated version
      otpSpan.textContent = truncateText(fullOtp);
      // Clear the input after successful generation
      document.getElementById('userInput').value = '';
    })
    .catch(error => {
      console.error('Error:', error);
      otpSpan.textContent = 'Error: ' + error.message;
    })
    .finally(() => {
      // Reset button state
      submitButton.disabled = false;
      submitButton.textContent = 'Submit';
    });
  }
  
  // Allow Enter key to submit
  document.getElementById('userInput').addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
      processInput();
    }
  });

  function copyToClipboard(elementId, button) {
    const element = document.getElementById(elementId);
    if (!element) {
      console.error('Element not found:', elementId);
      return;
    }
    
    // Get the full text from data attribute, fallback to textContent
    const textToCopy = element.getAttribute('data-full-text') || element.textContent;
    
    // Use the modern clipboard API
    if (navigator.clipboard && window.isSecureContext) {
      navigator.clipboard.writeText(textToCopy).then(() => {
        showCopyFeedback(button);
      }).catch(err => {
        console.error('Failed to copy: ', err);
        fallbackCopy(textToCopy, button);
      });
    } else {
      // Fallback for older browsers
      fallbackCopy(textToCopy, button);
    }
  }

  function fallbackCopy(text, button) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
      document.execCommand('copy');
      showCopyFeedback(button);
    } catch (err) {
      console.error('Fallback copy failed: ', err);
    }
    
    document.body.removeChild(textArea);
  }

  function showCopyFeedback(button) {
    console.log('showCopyFeedback', button);
    if (!button) return;
    
    const originalText = button.innerHTML;
    
    // Change icon to checkmark temporarily
    button.innerHTML = '<i class="material-icons cursor-pointer">check</i>';
    
    // Reset after 5 seconds
    setTimeout(() => {
      button.innerHTML = originalText;
    }, 5000);
  }
</script>

{% endblock %}
