{% block content %}
<div class="col-xl-6 col-lg-6 col-sm-12 mt-4 mb-3">
  <div
    class="card {% if darkmode %}dark-colors{% endif %}"
    style="height: 270px;">
    <div class="card-header pb-0 {% if darkmode %}dark-colors{% endif %}">
      <div class="row">
        <div class="col-lg-12 col-12">
          <h6 class="text-center {% if darkmode %}dark-colors{% endif %}" style="cursor: help" title="Enter Code">
            One-Time Password
          </h6>
          <p id="otp-outputStatus" class="text-sm mb-0 text-center {% if darkmode %}dark-colors{% endif %}">
          </p>
        </div>
      </div>
    </div>
    <div class="card-body px-0 pb-2">
      <p class="text-sm mb-0 text-center {% if darkmode %}dark-colors{% endif %}">
        Wallet Address: 
        <span id="walletAddress">{{ wallet.address }}</span>
        <button 
          type="button" 
          class="btn btn-sm btn-outline-secondary ms-2" 
          onclick="copyToClipboard('walletAddress')"
          title="Copy wallet address"
          style="padding: 2px 6px; font-size: 12px;"
        ><i class="fa-copy"></i>
        </button>
      </p>
      <div class="input-container">
        <div class="form-group">
          <label for="userInput" class="form-label {% if darkmode %}dark-colors{% endif %}">Enter Code:</label>
          <input 
            type="text" 
            id="userInput" 
            class="form-control {% if darkmode %}dark-colors{% endif %}" 
            placeholder="Enter Code"
          />
          <button 
            type="button" 
            id="submitButton" 
            class="btn btn-primary mt-2"
            onclick="processInput()"
          >
            Submit
          </button>
        </div>
      </div>
    </div>
    <div id="outputContainer" class="card-body" style="display: none;">
      <p class="text-sm mb-0 text-center {% if darkmode %}dark-colors{% endif %}">
        One-Time Password: 
        <span id="otp">Enter code above to generate OTP</span>
        <button 
          id="copyOtpButton"
          type="button" 
          class="btn btn-sm btn-outline-secondary ms-2" 
          onclick="copyToClipboard('otp')"
          title="Copy One-Time Password"
          style="padding: 2px 6px; font-size: 12px;"
        ><i class="fa-copy"></i></button>
      </p>
    </div>
  </div>
</div>

<script>
  function processInput() {
    var userInput = document.getElementById('userInput').value;
    var outputContainer = document.getElementById('outputContainer');
    var otpSpan = document.getElementById('otp');
    var submitButton = document.getElementById('submitButton');
    
    if (userInput.trim() === '') {
      alert('Please enter some text first!');
      return;
    }
    
    // Show loading state
    submitButton.disabled = true;
    submitButton.textContent = 'Generating...';
    otpSpan.textContent = 'Generating OTP...';
    outputContainer.style.display = 'block';
    
    // Call backend to generate OTP
    fetch('/generate/otp', { 
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ input: userInput })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      return response.json();
    })
    .then(data => {
      otpSpan.textContent = data.otp;
      // Clear the input after successful generation
      document.getElementById('userInput').value = '';
    })
    .catch(error => {
      console.error('Error:', error);
      otpSpan.textContent = 'Error: ' + error.message;
    })
    .finally(() => {
      // Reset button state
      submitButton.disabled = false;
      submitButton.textContent = 'Submit';
    });
  }
  
  // Allow Enter key to submit
  document.getElementById('userInput').addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
      processInput();
    }
  });

  function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    if (!element) {
      console.error('Element not found:', elementId);
      return;
    }
    
    const textToCopy = element.textContent;
    
    // Use the modern clipboard API
    if (navigator.clipboard && window.isSecureContext) {
      navigator.clipboard.writeText(textToCopy).then(() => {
        showCopyFeedback(event.target);
      }).catch(err => {
        console.error('Failed to copy: ', err);
        fallbackCopy(textToCopy, event.target);
      });
    } else {
      // Fallback for older browsers
      fallbackCopy(textToCopy, event.target);
    }
  }

  function fallbackCopy(text, button) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
      document.execCommand('copy');
      showCopyFeedback(button);
    } catch (err) {
      console.error('Fallback copy failed: ', err);
    }
    
    document.body.removeChild(textArea);
  }

  function showCopyFeedback(button) {
    if (!button) return;
    
    const originalText = button.innerHTML;
    
    // Change icon to checkmark temporarily
    button.innerHTML = '<i class="fa-solid fa-check"></i>';
    button.style.color = '#28a745';
    
    // Reset after 2 seconds
    setTimeout(() => {
      button.innerHTML = originalText;
      button.style.color = '';
    }, 2000);
  }
</script>

{% endblock %}
