{% block content %}
<div class="row mb-0" style='padding-bottom:1rem;'>
  <div class="col-xl-12 col-sm-12 mb-xl-0 mb-4">
    <div class="card {% if darkmode %}dark-colors{% endif %}">
      <div class="row" style='padding-left:2rem;padding-right:2rem;'>
        <div class="col-xl-1 col-sm-1 mb-xl-0"></div>
        <div class="col-xl-10 col-sm-10 mb-xl-0">
          <button class="btn btn-link w-100 text-left {% if darkmode %}dark-colors{% endif %}"
                  style="padding-top:1.5rem; text-transform: none;"
                  type="button"
                  data-toggle="collapse"
                  data-target="#inviteCardContent"
                  aria-expanded="false"
                  aria-controls="inviteCardContent">
                  <h4 class="{% if darkmode %}dark-colors{% endif %}">Mining Invite</h4>
          </button>
        </div>
        <div class="col-xl-1 col-sm-1 mb-xl-0">
        </div>
      </div>
      <div id="inviteCardContent" class="collapse show">
        <p class="text-sm mb-0 text-center {% if darkmode %}dark-colors{% endif %}" style="margin-left:1rem;margin-right:1rem;">
          If you were invited you can add their address below.<br>
          You can only do this once.
          <br><br>
        </p>
        <div class="row" style='padding-left:2rem;padding-right:2rem; padding-top: .1rem; padding-bottom: 2rem;'>
          <div class="col-xl-3 col-sm-3 mb-xl-0">
            <center>
              <p id="addInvitedByLabel" class="mb-1 {% if darkmode %}dark-colors{% endif %}" style="padding-top: .25rem;" onClick="toggleRewardAddresses();">
                Invited by:
              </p>
            </center>
          </div>
          <div class="col-xl-6 col-sm-6 mb-xl-0">
            <h6 class="mb-0 text-sm  {% if darkmode %}dark-text{% endif %}">
              <div class="d-flex px-3 py-1" style="padding-right: 1rem; margin-left:auto; margin-right: auto;">
                <div class="input-group input-group-outline">
                  <input
                    id="addInvitedBy"
                    name="addInvitedBy"
                    class="tight form-control {% if darkmode %}dark-colors{% endif %}"
                    style="text-align: center;"
                    maxLength="66"
                    placeholder="Enter address"
                    {% if invitedBy %}value="{{ invitedBy }}"{% endif %}
                    {% if invitedBy %}readonly{% endif %}
                    required=""
                    type="text"
                    onKeyPress="checkEnterForInvitedBy(event)">
                </div>
              </div>
            </h6>
          </div>
          <div class="col-xl-3 col-sm-3 mb-xl-0">
            <p id='addInvitedByConfirmation'></p>
          </div>
        </div>
        <div class="row">
          <div class="col-xl-12 col-lg-12 col-sm-12 mb-xl-0">
            <p class="text-sm mb-0 text-center {% if darkmode %}dark-colors{% endif %}">
              Help the Satori Network grow.<br>
              The bigger the network, the better the predictions.<br>
              Simply share your invite link to onboard others.<br>
            </p>
            <br>
            <p class="text-sm mb-3 text-center {% if darkmode %}dark-colors{% endif %}" style="margin-left: 10px; margin-right:10px;">
              https://satorinet.io/download/{{ wallet.address }}
            </p>
            <br>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Referral Stats Card -->
<div class="row mb-0" style='padding-bottom:1rem;'>
  <div class="col-xl-12 col-sm-12 mb-xl-0 mb-4">
    <div class="card {% if darkmode %}dark-colors{% endif %}">
      <div class="row" style='padding-left:2rem;padding-right:2rem;'>
        <div class="col-xl-12 col-sm-12 mb-xl-0">
          <button class="btn btn-link w-100 text-left {% if darkmode %}dark-colors{% endif %}"
                  style="padding-top:1.5rem; text-transform: none;"
                  type="button"
                  data-toggle="collapse"
                  data-target="#referralStatsContent"
                  aria-expanded="false"
                  aria-controls="referralStatsContent">
                  <h4 class="{% if darkmode %}dark-colors{% endif %}">Referral Stats</h4>
          </button>
        </div>
      </div>
      <div id="referralStatsContent" class="collapse show">
        <div class="row" style='padding-left:2rem;padding-right:2rem; padding-top: .5rem; padding-bottom: 2rem;'>
          <div class="col-xl-3 col-sm-6 mb-xl-0 mb-2">
            <p class="mb-1 {% if darkmode %}dark-colors{% endif %}">Referrals:</p>
            <h3 id="referralCount" class="{% if darkmode %}dark-colors{% endif %}">0</h3>
          </div>
          <div class="col-xl-3 col-sm-6 mb-xl-0 mb-2">
            <p class="mb-1 {% if darkmode %}dark-colors{% endif %}">Your Tier:</p>
            <h4 id="referralTier" class="{% if darkmode %}dark-colors{% endif %}" style="color: #9e9e9e;">None</h4>
          </div>
          <div class="col-xl-3 col-sm-6 mb-xl-0 mb-2">
            <p class="mb-1 {% if darkmode %}dark-colors{% endif %}">Reward Bonus:</p>
            <h4 id="referralBonus" class="{% if darkmode %}dark-colors{% endif %}" style="color: #4CAF50;">+0%</h4>
          </div>
          <div class="col-xl-3 col-sm-6 mb-xl-0 mb-2">
            <p class="mb-1 {% if darkmode %}dark-colors{% endif %}">Next Tier At:</p>
            <h4 id="nextTierAt" class="{% if darkmode %}dark-colors{% endif %}" style="color: #2196F3;">5 referrals</h4>
          </div>
        </div>
        <div class="row" style='padding-left:2rem;padding-right:2rem; padding-bottom: 1rem;'>
          <div class="col-xl-12 col-sm-12">
            <p class="text-sm mb-1 {% if darkmode %}dark-colors{% endif %}">Tier Progress:</p>
            <div class="progress" style="height: 20px;">
              <div id="tierProgress" class="progress-bar bg-gradient-primary" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
          </div>
        </div>
        <p class="text-sm mb-0 text-center {% if darkmode %}dark-colors{% endif %}" style="padding-bottom: 1rem; color: grey;">
          Tier bonuses: Bronze (5) +2% | Silver (25) +5% | Gold (100) +8% | Platinum (500) +12% | Diamond (2000) +15%
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Top Referrers Leaderboard -->
<div class="row mb-0" style='padding-bottom:1rem;'>
  <div class="col-xl-12 col-sm-12 mb-xl-0 mb-4">
    <div class="card {% if darkmode %}dark-colors{% endif %}">
      <div class="row" style='padding-left:2rem;padding-right:2rem;'>
        <div class="col-xl-12 col-sm-12 mb-xl-0">
          <button class="btn btn-link w-100 text-left {% if darkmode %}dark-colors{% endif %}"
                  style="padding-top:1.5rem; text-transform: none;"
                  type="button"
                  data-toggle="collapse"
                  data-target="#leaderboardContent"
                  aria-expanded="false"
                  aria-controls="leaderboardContent">
                  <h4 class="{% if darkmode %}dark-colors{% endif %}">Top Referrers</h4>
          </button>
        </div>
      </div>
      <div id="leaderboardContent" class="collapse">
        <div class="table-responsive" style="padding: 1rem 2rem 2rem 2rem;">
          <table class="table align-items-center mb-0 {% if darkmode %}table-dark{% endif %}">
            <thead>
              <tr>
                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Rank</th>
                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Address</th>
                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Referrals</th>
                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Tier</th>
                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Bonus</th>
              </tr>
            </thead>
            <tbody id="leaderboardTable">
              <tr>
                <td colspan="5" class="text-center text-sm {% if darkmode %}dark-colors{% endif %}">
                  Loading...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Tier thresholds for progress calculation
  const TIER_THRESHOLDS = [
    { name: 'None', count: 0, bonus: 0, color: '#9e9e9e' },
    { name: 'Bronze', count: 5, bonus: 2, color: '#cd7f32' },
    { name: 'Silver', count: 25, bonus: 5, color: '#c0c0c0' },
    { name: 'Gold', count: 100, bonus: 8, color: '#ffd700' },
    { name: 'Platinum', count: 500, bonus: 12, color: '#e5e4e2' },
    { name: 'Diamond', count: 2000, bonus: 15, color: '#b9f2ff' }
  ];

  document.addEventListener('DOMContentLoaded', (event) => {
    loadReferralStats();
    loadTopReferrers();
  });

  function loadReferralStats() {
    fetch('/referral/stats', { method: 'GET' })
      .then(response => response.json())
      .then(data => {
        const count = data.referral_count || 0;
        const tier = data.tier || 'None';
        const bonus = data.bonus_percent || 0;

        document.getElementById('referralCount').innerText = count;
        document.getElementById('referralTier').innerText = tier;
        document.getElementById('referralBonus').innerText = '+' + bonus + '%';

        // Set tier color
        const tierInfo = TIER_THRESHOLDS.find(t => t.name === tier) || TIER_THRESHOLDS[0];
        document.getElementById('referralTier').style.color = tierInfo.color;

        // Calculate next tier and progress
        const currentTierIndex = TIER_THRESHOLDS.findIndex(t => t.name === tier);
        const nextTier = TIER_THRESHOLDS[currentTierIndex + 1];

        if (nextTier) {
          document.getElementById('nextTierAt').innerText = nextTier.count + ' referrals';
          // Calculate progress to next tier
          const prevThreshold = tierInfo.count;
          const nextThreshold = nextTier.count;
          const progress = ((count - prevThreshold) / (nextThreshold - prevThreshold)) * 100;
          document.getElementById('tierProgress').style.width = Math.min(progress, 100) + '%';
        } else {
          document.getElementById('nextTierAt').innerText = 'Max tier!';
          document.getElementById('tierProgress').style.width = '100%';
        }
      })
      .catch(error => {
        console.error('Error loading referral stats:', error);
      });
  }

  function loadTopReferrers() {
    fetch('/referral/top?limit=10', { method: 'GET' })
      .then(response => response.json())
      .then(data => {
        const tbody = document.getElementById('leaderboardTable');

        if (!data.referrers || data.referrers.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center text-sm">No referrers yet</td></tr>';
          return;
        }

        tbody.innerHTML = data.referrers.map((r, index) => {
          const addrShort = r.address ? r.address.substring(0, 12) + '...' : 'Unknown';
          const tierInfo = TIER_THRESHOLDS.find(t => t.name === r.tier) || TIER_THRESHOLDS[0];
          const rank = index + 1;
          const rankEmoji = rank === 1 ? 'ðŸ¥‡' : (rank === 2 ? 'ðŸ¥ˆ' : (rank === 3 ? 'ðŸ¥‰' : rank));

          return `
            <tr>
              <td class="text-sm text-center">${rankEmoji}</td>
              <td class="text-sm" style="font-family: monospace;">${addrShort}</td>
              <td class="text-sm">${r.referral_count || 0}</td>
              <td class="text-sm" style="color: ${tierInfo.color};">${r.tier || 'None'}</td>
              <td class="text-sm" style="color: #4CAF50;">+${r.bonus_percent || 0}%</td>
            </tr>
          `;
        }).join('');
      })
      .catch(error => {
        console.error('Error loading top referrers:', error);
        document.getElementById('leaderboardTable').innerHTML =
          '<tr><td colspan="5" class="text-center text-sm">Error loading leaderboard</td></tr>';
      });
  }

  function checkEnterForInvitedBy(event){
    if (isFocused(document.querySelector('#addInvitedBy'))) {
      document.getElementById("addInvitedByConfirmation").innerHTML = '';
      if (event.key === "Enter" || event.keyCode === 13) {
        console.log('enter detected');
        setInvitedBy();
      }
    }
  }

  function setInvitedBy() {
    address = document.getElementById("addInvitedBy").value;
    fetch('/invited/by/' + address, { method: 'GET' })
    .then(response => {
        if (response.ok) {
          return response.text();
        } else {
          throw new Error('Network response was not ok.');
        }
    })
    .then(text => {
      if (text == 'OK') {
        document.getElementById("addInvitedByConfirmation").innerHTML = 'Saved!';
        loadReferralStats(); // Refresh stats after setting referrer
      } else {
        console.log(text);
        document.getElementById("addInvitedByConfirmation").innerHTML = 'Unable to save.';
      }
    }).catch(error => {
      document.getElementById("addInvitedByConfirmation").innerHTML = 'Unable to save.';
      console.error('Error:', error);
    });
  }

</script>
{% endblock %}
